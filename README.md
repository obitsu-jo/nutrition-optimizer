# 🍽️ Nutrition Optimizer （栄養最適化システム）

線形計画法を使って栄養バランスとコストを最適化する食事プランを提案する高度なツールです。

## 🎯 概要

日本食品標準成分表（八訂）を活用し、設定された栄養制約を満たしながら食費を最小化する最適な献立を自動計算します。科学的根拠に基づく栄養摂取基準と実際の食品価格を組み合わせた実用的なソリューションです。

## ✨ 主な特徴

- **🔬 科学的根拠**: 文部科学省「日本食品標準成分表」（八訂）を使用
- **📊 34種類の栄養制約**: エネルギー、主要栄養素、ビタミン、ミネラル、脂肪酸
- **💰 コスト最適化**: 線形計画法による最小コスト計算
- **🍱 柔軟な単位設定**: 100g、1個、1本など直感的な単位での価格設定
- **🔍 高度な食品検索**: 部分一致、ページネーション機能付き
- **📈 詳細分析**: 脂肪酸組成、栄養素充足率の可視化

## 🚀 クイックスタート

### 必要環境
- Python 3.11+
- 必要パッケージ: `pandas`, `pulp`, `openpyxl`

### インストール
```bash
pip install pandas pulp openpyxl
```

### 3ステップで実行

```bash
# Step1: 栄養制約を設定
python src/step1_constraints.py

# Step2: 食品選択と価格設定  
python src/step2_foods.py

# Step3: 最適化計算実行
python src/step3_optimize.py
```

## 📋 詳細ワークフロー

### Step1: 栄養制約設定 (`step1_constraints.py`)

**目的**: 最適化の目標となる栄養摂取基準を設定

**機能**:
- 34種類の栄養素制約を個別設定
- 最小値・最大値の柔軟な制約条件
- 有効/無効の切り替え機能
- 日本人の食事摂取基準（2020年版）準拠

**設定例**:
```
エネルギー: 2053-2509 kcal
たんぱく質: 74.14-114.06 g  
ビタミンC: 85 mg以上
カルシウム: 650-2500 mg
```

**出力**: `data/input/nutrition_constraints.csv`

### Step2: 食品管理 (`step2_foods.py`)

**目的**: 最適化に使用する食品の選択と価格設定

**主要機能**:

#### 🔍 高度な食品検索
- **部分一致検索**: 「とりむね」「さば缶」など簡単なキーワード
- **ページネーション**: 20件ずつ表示、全結果を閲覧可能
- **詳細情報表示**: エネルギー、主要栄養素を即座に確認

**検索例**:
```
追加する食品名を入力してください: とりむね

'とりむね'の検索結果 (ページ 1/1, 全7件):
  1. ＜鳥肉類＞　にわとり　［親・主品目］　むね　皮つき　生
     エネルギー: 229.0 kcal, たんぱく質: 19.5 g, 脂質: 17.2 g, 炭水化物: 0.0 g
  2. ＜鳥肉類＞　にわとり　［親・主品目］　むね　皮なし　生
     エネルギー: 121.0 kcal, たんぱく質: 24.4 g, 脂質: 1.9 g, 炭水化物: 0.0 g

操作: n: 次のページ, 番号: 食品を選択, 0: キャンセル
```

#### 💰 柔軟な価格設定
- **直感的な単位**: 100g、1個、1本、1枚、1kg、1袋、1缶、1パック
- **カスタム単位**: 任意の単位を設定可能
- **価格例**: 
  - 鶏むね肉: 60円/100g
  - 卵: 27円/1個
  - 米: 40円/100g

#### 📊 自動栄養データ統合
- **34栄養素**: 食品成分表から自動取得
- **脂肪酸分析**: n-3系、n-6系、飽和脂肪酸の詳細データ
- **データ精度**: 完全一致→キーワード一致→部分一致の3段階マッチング

**出力**: `data/input/foods.csv` (34栄養素 + 価格・制約情報)

### Step3: 最適化実行 (`step3_optimize.py`)

**目的**: 線形計画法による最適な食品組み合わせの計算

**最適化エンジン**:
- **ソルバー**: PuLP (CBC/GLPK)
- **目的関数**: 総食費の最小化
- **制約条件**: 
  - 栄養素の上下限制約
  - 食品の最小/最大摂取量制約
  - 有効食品のみ使用

**計算例**:
```
=== 🍽️ 栄養最適化結果 ===
💰 最小コスト: 876.64円/日

📊 推奨食品と摂取量:
  • こめ　［水稲穀粒］　精白米　うるち米
    摂取量: 4.37単位 (437.2g)
    コスト: 174.88円
  • ＜鳥肉類＞　にわとり　［親・主品目］　むね　皮つき　生
    摂取量: 3.45単位 (345.0g)  
    コスト: 207.00円

🎯 栄養成分充足状況:
  ✅ エネルギー: 2053.4/2053-2509 kcal (制約下限達成)
  ✅ たんぱく質: 107.2/74.14-114.06 g (適正範囲)
  ✅ ビタミンC: 85.0/85+ mg (制約下限達成)
  ✅ カルシウム: 650.0/650-2500 mg (制約下限達成)
```

**出力**: `data/output/optimization_result_YYYYMMDD_HHMMSS.json`

## 🏗️ システムアーキテクチャ

### プロジェクト構造
```
nutrition-optimizer/
├── src/
│   ├── step1_constraints.py      # 栄養制約設定UI
│   ├── step2_foods.py           # 食品管理UI (検索・選択・価格設定)
│   ├── step3_optimize.py        # 最適化実行・結果表示
│   └── core/                    # コアエンジン
│       ├── nutrition_calculator.py     # 栄養制約計算
│       ├── food_helper.py             # 食品データベース
│       ├── fatty_acid_integrator.py   # 脂肪酸データ統合
│       ├── nutrition_constraint_mapper.py # 栄養素マッピング
│       ├── hybrid_data_loader.py      # ハイブリッドデータ読み込み
│       ├── optimizer.py               # 線形計画法エンジン
│       ├── nutrition_mapping.py       # MEXT成分表マッピング
│       └── data_loader.py             # 基本データ読み込み
├── data/
│   ├── raw/                     # MEXT食品成分表（Excel）
│   │   ├── 20230428-mxt_kagsei-mext_00001_012.xlsx  # 一般成分表
│   │   └── 20230428-mxt_kagsei-mext_00001_032.xlsx  # 脂肪酸成分表
│   ├── input/                   # 設定ファイル
│   │   ├── nutrition_constraints.csv   # 栄養制約設定
│   │   ├── foods.csv                  # 食品・価格データ
│   │   └── calculation_info.json      # 計算パラメータ
│   └── output/                  # 最適化結果
└── docs/                        # ドキュメント
    ├── mapping.md               # 栄養素マッピング詳細
    └── energy.md               # エネルギー計算説明
```

### 技術仕様

**コアテクノロジー**:
- **線形計画法**: PuLP + CBC/GLPKソルバー
- **データ処理**: Pandas（2500+ 食品データ）
- **栄養分析**: 34制約 × 2533食品の多次元最適化

**データ統合アーキテクチャ**:
- **一般成分**: 食品成分表メインデータ（53栄養素）
- **脂肪酸成分**: 専用テーブルからの精密統合
- **制約マッピング**: 34制約への自動変換システム

**最適化アルゴリズム**:
```python
minimize: Σ(食品価格 × 摂取単位数)
subject to:
  - 各栄養素制約: min_value ≤ Σ(栄養素含量 × 摂取量) ≤ max_value
  - 食品制約: min_units ≤ 摂取単位数 ≤ max_units
  - 有効性制約: enabled = True
```

## 📊 対応栄養素（34項目）

### 🔥 エネルギー・主要栄養素 (5項目)
- エネルギー、たんぱく質、脂質、炭水化物、食物繊維

### 🍎 ビタミン (13項目)
- **脂溶性**: ビタミンA、D、E、K
- **水溶性**: ビタミンB₁、B₂、ナイアシン、B₆、B₁₂、葉酸、パントテン酸、ビオチン、ビタミンC

### ⚡ ミネラル (13項目)
- **主要ミネラル**: カリウム、カルシウム、マグネシウム、リン
- **微量ミネラル**: 鉄、亜鉛、銅、マンガン、ヨウ素、セレン、クロム、モリブデン、食塩相当量

### 🥑 脂肪酸 (3項目)
- n-3系脂肪酸、n-6系脂肪酸、飽和脂肪酸

## 🎯 使用例・ケーススタディ

### ケース1: 基本的な栄養バランス食
```bash
python src/step1_constraints.py  # デフォルト制約使用
python src/step2_foods.py       # 米、鶏肉、卵、野菜を追加
python src/step3_optimize.py    # 結果: 約900円/日
```

### ケース2: 高タンパク・低炭水化物食
```bash
# Step1でたんぱく質上限を増加、炭水化物上限を減少
# Step2で肉類、魚類、大豆製品を中心に選択
# 結果: 筋トレ向けの最適化献立
```

### ケース3: 低コスト重視
```bash
# Step2で安価な食材（米、卵、豆腐、もやし等）を中心に選択
# 結果: 必要栄養素を満たす最低限コストの献立
```

## 🔧 詳細設定

### 制約カスタマイズ
- **個別栄養素**: CSVファイル直接編集
- **食品制限**: min_units/max_units で摂取量制御
- **食品除外**: enabled=False で一時的に無効化

### データ拡張
- **新食品追加**: step2から簡単追加
- **価格更新**: foods.csvで一括更新
- **季節対応**: 旬の食材価格を反映

## 🚨 トラブルシューティング

### よくある問題

**Q: 最適化が失敗する（解なし）**
A: 制約が厳しすぎる可能性があります
- 制約値を緩和（特に上下限の幅を広げる）
- より多様な食品を追加
- enabled=Falseの食品を確認

**Q: 同じ食品ばかり選ばれる**
A: 正常な最適化結果です
- より多様性を求める場合は最大摂取量を制限
- 異なる価格帯の食品を追加

**Q: 食品検索で見つからない**
A: 検索キーワードを調整
- より短いキーワード（「鶏」「魚」など）
- ひらがな・カタカナ表記を試す
- ページネーションで全結果を確認

**Q: 栄養値が0になる**
A: データマッピングの問題
- 最新版のMEXT食品成分表を使用
- 食品名の完全一致を確認

### デバッグ情報
```bash
# 詳細ログを有効化（開発用）
export NUTRITION_DEBUG=1
python src/step3_optimize.py
```

## 📈 今後の発展可能性

- **機械学習**: 過去の最適化結果から嗜好を学習
- **季節対応**: 旬の食材価格データベース
- **アレルギー対応**: 除外食品の自動制御
- **レシピ生成**: 最適化結果から具体的な調理指示
- **栄養教育**: 制約条件の健康影響可視化

## 📚 参考文献

- [日本食品標準成分表2020年版（八訂）](https://www.mext.go.jp/a_menu/syokuhinseibun/mext_00001.html)
- [日本人の食事摂取基準（2020年版）](https://www.mhlw.go.jp/stf/newpage_08517.html)
- 線形計画法: Dantzig, G. B. (1963). Linear Programming and Extensions.

---

## 📝 ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 🤝 コントリビューション

Issue報告やプルリクエストを歓迎します。栄養学、最適化、UI/UXの改善提案をお待ちしています。